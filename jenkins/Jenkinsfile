pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "roshaan1103/kaniko-test"
        DOCKER_TAG = "${BUILD_NUMBER}"
    }

    stages {

        stage('Build & Push Image with Kaniko') {
            steps {
                sh """
                kubectl run kaniko-${BUILD_NUMBER} \
                  --namespace=jenkins \
                  --restart=Never \
                  --image=gcr.io/kaniko-project/executor:latest \
                  --overrides='{
                    "spec": {
                      "containers": [{
                        "name": "kaniko",
                        "image": "gcr.io/kaniko-project/executor:latest",
                        "args": [
                          "--dockerfile=jenkins/Dockerfile",
                          "--context=git://github.com/roshaan1103/kaniko-test.git",
                          "--destination=${DOCKER_IMAGE}:${DOCKER_TAG}"
                        ],
                        "volumeMounts": [{
                          "name": "docker-config",
                          "mountPath": "/kaniko/.docker"
                        }]
                      }],
                      "volumes": [{
                        "name": "docker-config",
                        "secret": {
                          "secretName": "dockerhub-secret",
                          "items": [{
                            "key": ".dockerconfigjson",
                            "path": "config.json"
                         }]
                        }
                      }]
                    }
                  }'
                """
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                sh """
                kubectl apply -f jenkins/kaniko-app.yaml -n jenkins

                kubectl set image deployment/kaniko-app \
                kaniko-app=${DOCKER_IMAGE}:${DOCKER_TAG} \
                -n jenkins

                kubectl rollout status deployment/kaniko-app -n jenkins
                """
            }
        } 

    }
}
