pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "roshaan1103/kaniko-test"
        DOCKER_TAG = "${BUILD_NUMBER}"
    }

    stages {

        stage('Build & Push Image with Kaniko') {
            steps {
                sh """
                kubectl run kaniko-${BUILD_NUMBER} \
                  --namespace=jenkins \
                  --restart=Never \
                  --image=gcr.io/kaniko-project/executor:latest \
                  --overrides='{
                    "spec": {
                      "containers": [{
                        "name": "kaniko",
                        "image": "gcr.io/kaniko-project/executor:latest",
                        "args": [
                          "--dockerfile=jenkins/Dockerfile",
                          "--context=git://github.com/roshaan1103/kaniko-test.git",
                          "--destination=${DOCKER_IMAGE}:${DOCKER_TAG}"
                        ],
                        "volumeMounts": [{
                          "name": "docker-config",
                          "mountPath": "/kaniko/.docker"
                        }]
                      }],
                      "volumes": [{
                        "name": "docker-config",
                        "secret": {
                          "secretName": "dockerhub-secret"
                        }
                      }]
                    }
                  }'
                """
            }
        }
    }
}
